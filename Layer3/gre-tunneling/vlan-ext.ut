:TESTCASE-BEGIN:1
:DESC: VLAN extenstion using GRE Overlay tunnel

:PRINT: Topology to be loaded in testapp.c : vlan_extension_topo(); 

:PRINT:
:PRINT:                             +-------------GRE-Tunnel----------+
:PRINT:                             |                                 |
:PRINT:                             |                                 |
:PRINT:                             v                                 v
:PRINT:                                                               
:PRINT:                         +---+-----+                     +----------+
:PRINT:                  v10,acc|         |20.1.1.1         eth1|          |v10,acc
:PRINT:       +-----------+-----|   R1    +---------------------+   R2     +--------------+
:PRINT:       |             eth0|100.1.1.1|eth1         20.1.1.2|100.1.1.2 |eth0          |eth0
:PRINT:       |                 +---------+                     +----------+              |10.1.1.2/24
:PRINT:   eth0|10.1.1.1/24                                                           +---+-----+
:PRINT:   +---+----+                                                                 |  H2     |
:PRINT:   +   H1   |                                                                 |122.1.1.2+       
:PRINT:   |122.1.1.1                                                                 +---------+
:PRINT:   +--------+
:PRINT:
:PRINT:


:PRINT: Setting up the Configuration

:PRINT: 1. Set the GRE Tunnel-End point on R1
:STEP:1

:CMD: config node R1 interface tunnel 2
:CMD: config node R1 interface tunnel 2 tunnel-source 100.1.1.1
:CMD: config node R1 interface tunnel 2 tunnel-destination 100.1.1.2
:CMD: config node R1 interface tunnel 2 ip-address 192.168.0.1 24

:PRINT: 2. Set up the vlan 10 and Transport-service-profile on R1
:STEP:2

:CMD: config node R1 interface vlan 10
:CMD: config node R1 transport-service-profile tsp10
:CMD: config node R1 transport-service-profile tsp10 vlan 10

:PRINT: 3. Set up the virtual-port on R1
:STEP:3

:CMD: config node R1 interface virtual-port vp-to-gre 
:CMD: config node R1 interface virtual-port vp-to-gre transport-service-profile tsp10
:CMD: config node R1 interface virtual-port vp-to-gre overlay-tunnel tunnel2

:PRINT: 4. Setup Route on R1 to reach R2 
:STEP:4

:CMD: config node R1 route 100.1.1.2 32 20.1.1.2 eth1


:PRINT: 5. Set the GRE Tunnel-End point on R2
:STEP:5

:CMD: config node R2 interface tunnel 2
:CMD: config node R2 interface tunnel 2 tunnel-source 100.1.1.2
:CMD: config node R2 interface tunnel 2 tunnel-destination 100.1.1.1
:CMD: config node R2 interface tunnel 2 ip-address 192.168.0.2 24

:PRINT: 6. Set the GRE Tunnel-End point on R2
:STEP:6

:CMD: config node R2 interface tunnel 2
:CMD: config node R2 interface tunnel 2 tunnel-source 100.1.1.2
:CMD: config node R2 interface tunnel 2 tunnel-destination 100.1.1.1
:CMD: config node R2 interface tunnel 2 ip-address 192.168.0.2 24


:PRINT: 7. Set up the vlan 10 and Transport-service-profile on R2
:STEP:7

:CMD: config node R2 interface vlan 10
:CMD: config node R2 transport-service-profile tsp10
:CMD: config node R2 transport-service-profile tsp10 vlan 10

:PRINT: 8. Set up the virtual-port on R2
:STEP:8

:CMD: config node R2 interface virtual-port vp-to-gre 
:CMD: config node R2 interface virtual-port vp-to-gre transport-service-profile tsp10
:CMD: config node R2 interface virtual-port vp-to-gre overlay-tunnel tunnel2

:PRINT: 9. Setup Route on R2 to reach R1
:STEP:9

:CMD: config node R2 route 100.1.1.1 32 20.1.1.1 eth1

:PRINT: Configuration Completed.

:PRINT: Verification 1 : Test the VLAN Extension using GRE Overlay Tunnel

:PRINT: 1.1 Send ping packet from H1 to H2 with VLAN 10
:STEP:10
:CMD: run node H1 ping 10.1.1.2
:SLEEP:3

:PRINT: 1.2 Verify the packet received on H2
:STEP:11
:CMD: show node H2 interface statistics
:STEP:12
:PATTERN-MATCH:PktTx : 1, PktRx : 2
:PRINT: 1.3 Verify ARP entires on H2
:STEP:13
:CMD: show node H2 arp
:STEP:14
:PATTERN-MATCH:10.1.1.1
:STEP:15
:PATTERN-MATCH:eth0
:STEP:16
:PATTERN-MATCH:true
:STEP:17
:PATTERN-MATCH:arp

:PRINT: Verification 2 : Check MAC entries on R2

:PRINT: 2.1 Verify MAC entries on R2
:STEP:18
:CMD: show node R2 mac
:STEP:19
:PATTERN-MATCH:eth0
:STEP:20
:PATTERN-MATCH:vp-to-gre
:STEP:21
:PATTERN-MATCH:10

:PRINT: Verification 3 : Check MAC entries on R1

:PRINT: 3.1 Verify MAC entries on R1   
:STEP:22
:CMD: show node R1 mac
:STEP:23
:PATTERN-MATCH:eth0
:STEP:24
:PATTERN-MATCH:vp-to-gre
:STEP:25
:PATTERN-MATCH:10

:PRINT: Verification 4 : Check ARP entries on H1

:PRINT: 4.1 Verify ARP entries on H1
:STEP:26
:CMD: show node H1 arp
:STEP:27
:PATTERN-MATCH:10.1.1.2
:STEP:28
:PATTERN-MATCH:eth0
:STEP:29
:PATTERN-MATCH:true
:STEP:30
:PATTERN-MATCH:arp


:PRINT: Verification 5 : Check pkt_block memory leakage

:PRINT: 5.1 Check pkt_block memory leakage
:STEP:31
:CMD: debug mem-usage | include pkt_block_t
:STEP:32
:PATTERN-MATCH:TBC : 0
:STEP:33
:PATTERN-MATCH:OBC : 0

:PRINT: Testcase Finished

:PRINT: Unconfiguring the topology

:PRINT: Unconfiguring the node R1 

:STEP:34
:CMD: config node R1 no route 100.1.1.2 32 20.1.1.2 eth1
:STEP:35
:CMD: config node R1 no interface virtual-port vp-to-gre overlay-tunnel tunnel2
:STEP:36
:CMD: config node R1 no interface virtual-port vp-to-gre transport-service-profile tsp10
:STEP:37
:CMD: config node R1 no interface virtual-port vp-to-gre
:STEP:38
:CMD: config node R1 no transport-service-profile tsp10 vlan 10
:STEP:39    
:CMD: config node R1 no transport-service-profile tsp10
:STEP:41
:CMD: config node R1 no route 192.168.0.0 24
:STEP:42
:CMD: config node R1 no route 192.168.0.1 32
:STEP:43
:CMD: config node R1 no interface tunnel 2

:PRINT: Unconfiguring the node R2

:STEP:44
:CMD: config node R2 no route 100.1.1.1 32 20.1.1.1 eth1
:STEP:35
:CMD: config node R2 no interface virtual-port vp-to-gre overlay-tunnel tunnel2
:STEP:36
:CMD: config node R2 no interface virtual-port vp-to-gre transport-service-profile tsp10
:STEP:37
:CMD: config node R2 no interface virtual-port vp-to-gre
:STEP:38
:CMD: config node R2 no transport-service-profile tsp10 vlan 10
:STEP:39    
:CMD: config node R2 no transport-service-profile tsp10
:STEP:41
:CMD: config node R2 no route 192.168.0.0 24
:STEP:42
:CMD: config node R2 no route 192.168.0.2 32
:STEP:43
:CMD: config node R2 no interface tunnel 2


:PRINT: Verifying whether all Configuration is cleaned up

:STEP:44
:CMD: show node R1 interface statistics
:STEP:45
:PATTERN-NOT-MATCH:tunnnel2
:STEP:46
:PATTERN-NOT-MATCH:vp-to-gre
:STEP:47
:CMD: show node R1 transport-service-profile
:STEP:48
:PATTERN-NOT-MATCH:tsp10
:STEP:49
:CMD: show node R1 rt 
:STEP:50
:PATTERN-NOT-MATCH:100.1.1.2
:STEP:51
:PATTERN-NOT-MATCH:192.168.0

:STEP:52
:CMD: show node R2 interface statistics
:STEP:53
:PATTERN-NOT-MATCH:tunnnel2
:STEP:54
:PATTERN-NOT-MATCH:vp-to-gre
:STEP:55
:CMD: show node R2 transport-service-profile
:STEP:56
:PATTERN-NOT-MATCH:tsp10
:STEP:57
:CMD: show node R2 rt 
:STEP:58
:PATTERN-NOT-MATCH:100.1.1.1
:STEP:59
:PATTERN-NOT-MATCH:192.168.0


:TESTCASE-END:1
















